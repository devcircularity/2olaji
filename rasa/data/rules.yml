# Updated rules.yml - Enhanced with form-based student creation for context awareness
version: "3.1"

rules:

- rule: Say goodbye anytime the user says goodbye
  steps:
  - intent: goodbye
  - action: utter_goodbye

- rule: Say 'I am a bot' anytime the user challenges
  steps:
  - intent: bot_challenge
  - action: utter_iamabot

- rule: Respond to help requests
  steps:
  - intent: ask_help
  - action: action_help

# UPDATED: Form-based student creation for context awareness
- rule: Activate student creation form
  steps:
  - intent: create_student
  - action: student_creation_form
  - active_loop: student_creation_form

- rule: Submit student creation form
  condition:
  - active_loop: student_creation_form
  steps:
  - action: student_creation_form
  - active_loop: null
  - action: action_create_student

- rule: Handle admission number in form context
  condition:
  - active_loop: student_creation_form
  steps:
  - intent: provide_admission_number
  - action: student_creation_form

- rule: Handle auto generate in form context
  condition:
  - active_loop: student_creation_form
  steps:
  - intent: auto_generate_admission
  - action: action_auto_generate_admission
  - action: student_creation_form

- rule: Handle class assignment in form context
  condition:
  - active_loop: student_creation_form
  steps:
  - intent: assign_student_to_class
  - action: student_creation_form

# Keep this for backward compatibility (non-form flow)
- rule: Assign student to class (follow-up)
  steps:
  - intent: assign_student_to_class
  - action: action_assign_student_to_class

- rule: List all students
  steps:
  - intent: list_students
  - action: action_list_students

- rule: List students by class
  steps:
  - intent: list_students_by_class
  - action: action_list_students_by_class

- rule: Show unassigned students
  steps:
  - intent: show_unassigned_students
  - action: action_list_unassigned_students

- rule: Search for a student
  steps:
  - intent: search_student
  - action: action_search_student

- rule: Get student details
  steps:
  - intent: get_student_details
  - action: action_search_student

- rule: Create a class
  steps:
  - intent: create_class
  - action: action_create_class

- rule: List all classes
  steps:
  - intent: list_classes
  - action: action_list_classes

- rule: List empty classes
  steps:
  - intent: list_empty_classes
  - action: action_list_empty_classes

- rule: Create academic year
  steps:
  - intent: create_academic_year
  - action: action_create_academic_year

- rule: Create academic term
  steps:
  - intent: create_academic_term
  - action: action_create_academic_term

- rule: Check academic setup
  steps:
  - intent: check_academic_setup
  - action: action_check_academic_setup

- rule: Get current academic year
  steps:
  - intent: get_current_academic_year
  - action: action_get_current_academic_year

- rule: Get current term
  steps:
  - intent: get_current_term
  - action: action_get_current_term

- rule: Respond to greeting
  steps:
  - intent: greet
  - action: utter_greet

- rule: Respond to affirmation
  steps:
  - intent: affirm
  - action: utter_affirm

- rule: Respond to denial
  steps:
  - intent: deny
  - action: utter_deny

- rule: Handle fallback
  steps:
  - intent: nlu_fallback
  - action: utter_default

# REMOVED: These are now handled by the form
# - rule: Provide admission number
# - rule: Auto generate admission number

- rule: Deactivate academic year
  steps:
  - intent: deactivate_academic_year
  - action: action_deactivate_academic_year

- rule: Activate academic year
  steps:
  - intent: activate_academic_year
  - action: action_activate_academic_year

- rule: Promote students
  steps:
  - intent: promote_students
  - action: action_promote_students

- rule: Activate term
  steps:
  - intent: activate_term
  - action: action_activate_term

- rule: List academic terms
  steps:
  - intent: list_academic_terms
  - action: action_list_academic_terms

- rule: Re-enroll student
  steps:
  - intent: reenroll_student
  - action: action_reenroll_student

- rule: Create fee structure
  steps:
  - intent: create_fee_structure
  - action: action_create_fee_structure

- rule: List fee structures
  steps:
  - intent: list_fee_structures
  - action: action_list_fee_structures

- rule: Generate invoices
  steps:
  - intent: generate_invoices
  - action: action_generate_invoices

- rule: Get invoice
  steps:
  - intent: get_invoice
  - action: action_get_invoice

- rule: Add fee item
  steps:
  - intent: add_fee_item
  - action: action_add_fee_item

- rule: View fee structure details
  steps:
  - intent: view_fee_structure_details
  - action: action_view_fee_structure_details

- rule: Delete all fee items
  steps:
  - intent: delete_fee_items
  - action: action_delete_fee_items

- rule: Delete specific fee item
  steps:
  - intent: delete_specific_fee_item
  - action: action_delete_specific_fee_item

- rule: Publish fee structure
  steps:
  - intent: publish_fee_structure
  - action: action_publish_fee_structure

- rule: Delete class
  steps:
  - intent: delete_class
  - action: action_delete_class

- rule: Handle affirm set default after publish
  steps:
    - intent: affirm_set_default
    - action: action_set_default_fee_structure

- rule: Handle deny set default after publish
  steps:
    - intent: deny_set_default
    - action: utter_acknowledged

- rule: Set structure as default
  steps:
    - intent: set_structure_as_default
    - action: action_set_structure_as_default

- rule: Issue invoices
  steps:
  - intent: issue_invoices
  - action: action_issue_invoices

- rule: List all invoices
  steps:
  - intent: list_invoices
  - action: action_list_invoices

- rule: List invoices by class
  steps:
  - intent: list_invoices_by_class
  - action: action_list_invoices_by_class

- rule: List unpaid invoices
  steps:
  - intent: list_unpaid_invoices
  - action: action_list_unpaid_invoices

- rule: Cancel invoice
  steps:
  - intent: cancel_invoice
  - action: action_cancel_invoice

- rule: Record payment
  steps:
  - intent: record_payment
  - action: action_record_payment

- rule: Add guardian
  steps:
  - intent: add_guardian
  - action: action_add_guardian

- rule: Get guardians
  steps:
  - intent: get_guardians
  - action: action_get_guardians

- rule: List students without guardians
  steps:
  - intent: list_students_without_guardians
  - action: action_list_students_without_guardians

- rule: Notify pending invoices
  steps:
  - intent: notify_pending_invoices
  - action: action_notify_pending_invoices

- rule: Set primary guardian
  steps:
  - intent: set_primary_guardian
  - action: action_set_primary_guardian

- rule: Update guardian
  steps:
  - intent: update_guardian
  - action: action_update_guardian

- rule: Send guardian message
  steps:
  - intent: send_guardian_message
  - action: action_send_guardian_message

- rule: Get school information
  steps:
  - intent: get_school_info
  - action: action_get_school_info

- rule: Complete term
  steps:
  - intent: complete_term
  - action: action_complete_term

- rule: Send payment notification on affirmative response
  condition:
    - slot_was_set:
      - pending_payment_notification: "yes"
  steps:
    - or:
      - intent: affirm
      - intent: affirm_send_payment_notification
    - action: action_send_payment_notification

- rule: Skip payment notification on negative response
  condition:
    - slot_was_set:
      - pending_payment_notification: "yes"
  steps:
    - or:
      - intent: deny
      - intent: deny_send_payment_notification
    - action: action_listen
    - action: action_reset_slots

- rule: Notify parents with balances
  steps:
  - intent: notify_parents_with_balances
  - action: action_notify_parents_with_balances

- rule: Broadcast message to all parents
  steps:
  - intent: broadcast_message_to_all_parents
  - action: action_broadcast_message_to_all_parents

- rule: List students with balances
  steps:
  - intent: list_students_with_balances
  - action: action_list_students_with_balances

forms:
  student_creation_form:
    required_slots:
      - student_name
      - admission_no
      - class_name

  
